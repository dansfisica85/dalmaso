# Chat Log - Projeto Dalmaso - 02/03/2026

## Resumo da Sessão

### 1. Bug Fix: Cards de turmas sumiram na página Início
- **Problema**: Os cards de todas as turmas desapareceram na página Início
- **Causa**: SQLite DB é efêmero no Vercel — `/api/turmas` retorna `[]` após cada deploy
- **Solução**: Modificado `loadInicio()` em `js/app.js` para fazer fallback para dados CSV quando DB está vazio
- **Status**: ✅ Corrigido e deployed — 33 turmas aparecem via CSV

---

### 2. Feature: Painel de Alertas WhatsApp
**Pedido do usuário**: Enviar mensagem automática no WhatsApp para alunos que faltam no dia e para alunos com presença abaixo de 75%.

#### 2.1 Análise dos Dados
- `dados_alunos.csv`: 1.379 alunos, encoding **latin-1**, delimitador `;`
- Coluna `telefones_formatados`: formato `Celular: (16) 994352785 - Mãe | Residencial: (16) 991445357 - Mãe`
- Alguns números em notação científica: `9.93175e+008`
- **1.309 alunos** com número de WhatsApp extraído
- **70 alunos** sem telefone

#### 2.2 Backend — `/api/alertas-frequencia` (api/index.py)

**Novas funções adicionadas:**
- `CSV_ALUNOS_PATH` — constante para caminho do CSV
- `_load_alunos_csv()` — leitor multi-encoding (tenta utf-8-sig, utf-8, latin-1, cp1252, iso-8859-1)
- `_get_alunos_data()` — cache de 120 segundos
- `_classificar_turma_periodo()` — clasifica turma em manhã/tarde/noturno com dict `_PERIODOS` inline

**Endpoint GET `/api/alertas-frequencia`**
- Parâmetros opcionais: `turno`, `tipo`, `turma`
- Cruza dados de alunos com dados de frequência por turma
- Extrai celulares via regex (inclui tratamento de notação científica)
- Formato WhatsApp: `5516XXXXXXXXX` (55=Brasil, 16=DDD, 9 dígitos)

**Resposta:**
```json
{
  "resumo": {
    "total_alunos": 1379,
    "total_criticos": 1146,
    "total_atencao": 147,
    "total_com_whatsapp": 1309,
    "total_sem_whatsapp": 70,
    "total_turmas_criticas": 27
  },
  "alunos": [{
    "nome": "AGATHA PALMEIRA SANTOS",
    "turma": "1A",
    "turma_display": "1º A - Manhã",
    "ra": "...",
    "responsavel": "...",
    "periodo": "manha",
    "celulares": ["5516991512777"],
    "tem_whatsapp": true,
    "telefones_raw": "...",
    "presenca_pct_turma": 62.3,
    "status": "critico"
  }],
  "turmas": [...],
  "mensagem_modelo_falta": "...",
  "mensagem_modelo_critico": "...",
  "timestamp": "..."
}
```

#### 2.3 Bugs corrigidos durante implementação
1. **Encoding**: `dados_alunos.csv` é latin-1, não UTF-8 → multi-encoding reader
2. **PERIODOS_CONFIG NameError**: Estava só no JS, referenciado no Python → adicionado dict inline `_PERIODOS`
3. **Coluna com acento**: `série/ano` tem `é` acentuado → tenta variações: `série/ano`, `s\u00e9rie/ano`, `serie/ano`
4. **Notação científica**: Números como `9.93175e+008` → tratados com `int(float(num_raw))`

#### 2.4 Frontend — HTML (index.html)

**Sidebar**: Adicionado item `Alertas WhatsApp` com ícone `bi-whatsapp`

**Seção `page-alertas-whatsapp`:**
- Filtros por turno (Manhã/Tarde/Noturno) e tipo (Crítico/Atenção/Regular)
- 6 cards de resumo (total, críticos, atenção, com WhatsApp, sem telefone, turmas críticas)
- Banner informativo sobre Evolution API
- Container de gráfico Plotly (`wpp-chart-turmas`)
- Tabela paginada com busca e exportação (8 colunas)
- Modal de configuração Evolution API (URL, Token, Instância)

#### 2.5 Frontend — CSS (css/style.css)

**~165 linhas adicionadas:**
- Badges: `.wpp-badge-critico` (vermelho), `.wpp-badge-atencao` (amarelo), `.wpp-badge-regular` (verde), `.wpp-badge-sem-tel` (cinza)
- Tabela `#wpp-tabela-alunos` com dark theme
- Botão WhatsApp `.btn-wpp-enviar` (verde #25d366)
- Barra de frequência `.wpp-freq-bar` (inline progress bar)
- Paginação dark `#wpp-paginacao`
- Breakpoints responsivos

#### 2.6 Frontend — JavaScript (js/app.js)

**~315 linhas adicionadas:**

**Variáveis de estado:**
- `_wppCache`, `_wppFiltroTurno`, `_wppFiltroTipo`, `_wppPagina`, `WPP_POR_PAGINA=50`, `_wppListenersInit`

**Funções:**
- `loadAlertasWhatsapp()` — fetch + atualiza cards + renderiza
- `_wppSetText(id, val)` — helper para atualizar texto
- `_wppInitListeners()` — event listeners dos filtros/busca
- `_wppFilterBySearch(alunos, termo)` — busca por nome/turma/responsável/RA
- `_wppRenderChart(turmas)` — gráfico Plotly com linha de corte 75%
- `_wppRenderTabela(alunos)` — tabela paginada (50/página)
- `_wppRenderPaginacao(total)` — max 7 botões de página
- `_wppFormatPhone(num)` — formata `5516994352785` → `(16) 99435-2785`
- `_wppEnviarMsg(numero, nomeAluno)` — envia via Evolution API ou fallback `wa.me`
- `_wppExportarCSV()` — exporta CSV com BOM (delimitador `;`)

**Lógica de envio:**
1. Verifica `localStorage.getItem('wpp_config')` para configuração Evolution API
2. Se configurado → POST para `{url}/message/sendText/{instancia}` com apikey
3. Se não configurado → abre `https://wa.me/{numero}?text=...` em nova aba

#### 2.7 Testes e Deploy
- **Teste local**: ✅ 200 OK — 1.379 alunos, 1.146 críticos, 1.309 com WhatsApp
- **Deploy Vercel**: ✅ `npx vercel --prod --yes --token "<VERCEL_TOKEN>"`
- **Teste produção**: ✅ `https://dalmaso.vercel.app/api/alertas-frequencia` retorna dados corretos
- **URL**: https://dalmaso.vercel.app/

---

### 3. Plano para Evolution API na Oracle Cloud (Always Free)

#### 3.1 Criar conta Oracle Cloud
- URL: https://www.oracle.com/cloud/free/
- Região recomendada: **Brazil East (São Paulo)**
- Plano Always Free — não cobra

#### 3.2 Criar VM Always Free
- Shape: `VM.Standard.A1.Flex` (ARM)
- OCPUs: 2 (max 4 grátis)
- Memory: 12 GB (max 24 GB grátis)
- Image: Ubuntu 22.04 ou 24.04

#### 3.3 Liberar portas
- **Security List Oracle**: Ingress Rule porta 8080, TCP, source 0.0.0.0/0
- **Firewall Ubuntu**:
```bash
sudo iptables -I INPUT 6 -m state --state NEW -p tcp --dport 8080 -j ACCEPT
sudo netfilter-persistent save
```

#### 3.4 Docker + Evolution API
```bash
# Instalar Docker
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker $USER

# docker-compose.yml
# image: atendai/evolution-api:latest
# porta: 8080
# env: AUTHENTICATION_API_KEY, SERVER_URL
# volumes: evolution_store, evolution_instances
```

#### 3.5 Criar instância e conectar chip
```bash
# Criar instância
curl -X POST "http://IP:8080/instance/create" \
  -H "apikey: CHAVE" \
  -d '{"instanceName":"dalmaso-escola","integration":"WHATSAPP-BAILEYS","qrcode":true}'

# QR Code para escanear
curl "http://IP:8080/instance/connect/dalmaso-escola" -H "apikey: CHAVE"
```

#### 3.6 Configurar no Dalmaso
- Acessar Alertas WhatsApp → ⚙ Configurar WhatsApp
- URL da API: `http://IP_PUBLICO:8080`
- API Key: chave definida no docker-compose
- Instância: `dalmaso-escola`

#### 3.7 Custos
| Item | Custo |
|------|-------|
| Oracle Cloud VM (Always Free) | R$ 0/mês |
| Evolution API (open source) | R$ 0 |
| Chip WhatsApp dedicado | ~R$ 15/mês |
| **Total** | **~R$ 15/mês** |

---

## Informações Técnicas do Projeto

### Credenciais e Config
- **Vercel Project**: `prj_QoiRu5DjuFmJccJRA8TfyY2khmoI`
- **Vercel Token**: `<VERCEL_TOKEN>` (salvo localmente, não commitar)
- **Vercel Org**: `team_F1ZmHFVrmAUoyAu7yh8ONHme`
- **URL Produção**: https://dalmaso.vercel.app/
- **Senha Admin**: `dalmaso2025`
- **Senha Frequência**: `frequencia2025`

### Estrutura de Períodos
```
Manhã: 1A, 1B, 1C, 2A, 2B, 2C, 3A, 3B, 3C
Tarde: 6A, 6B, 6C, 6D, 7A, 7B, 7C, 7D, 8A, 8B, 8C, 8D, 9A, 9B, 9C, 9D
Noturno: 1G, 2F, 2G, 3D, 3E
```

### CSVs Importantes
- `dados_alunos.csv` — 1.379 alunos, encoding latin-1, delimitador `;`
  - Coluna 0: `série/ano` (turma)
  - Coluna 3: `nome`
  - Coluna 7: `responsavel_lista`
  - Coluna 66: `telefones_formatados`
- `FREQUENCIA ATE 28-02-2026.csv` — frequência agregada por turma
- `Dalmaso MANHA.csv`, `Dalmaso TARDE.csv`, `Dalmaso NOTURNO.csv` — turmas por período

### Arquivos Modificados Nesta Sessão
1. `api/index.py` (~2150+ linhas) — endpoint alertas + funções auxiliares
2. `index.html` (~835+ linhas) — seção alertas WhatsApp + sidebar
3. `css/style.css` (~1480+ linhas) — estilos dark theme WhatsApp
4. `js/app.js` (~2234+ linhas) — módulo completo WhatsApp + fix loadInicio

---

## Próximos Passos Pendentes
1. ⬜ Criar conta Oracle Cloud
2. ⬜ Criar VM Always Free (ARM, Ubuntu)
3. ⬜ Instalar Docker + Evolution API
4. ⬜ Comprar chip dedicado para escola
5. ⬜ Conectar chip via QR Code
6. ⬜ Configurar URL/Token/Instância no painel Dalmaso
7. ⬜ Testar envio automático de mensagens
8. ⬜ (Futuro) Implementar envio automático diário via cron/scheduled task
9. ⬜ (Futuro) Configurar HTTPS com certificado SSL
10. ⬜ (Futuro) Adicionar DNS fixo (DuckDNS ou Reserved IP Oracle)
